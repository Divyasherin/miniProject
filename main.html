<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Practice English - Thanglish</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      min-height: 100%;
      background: linear-gradient(135deg, #d84ba9, #8bcfee);
      color: #0f172a;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 40px 20px 20px 20px;
      color: white;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
    }

    header h1 {
      font-weight: 700;
      font-size: 2.8rem;
    }

    header p {
      font-size: 1.2rem;
      margin-top: 10px;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .practice-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #taskParagraph {
      background: white;
      border-radius: 12px;
      padding: 25px;
      font-size: 1.2rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      min-height: 100px;
      display: flex;
      align-items: center;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .btn-custom {
      flex: 1;
      min-width: 120px;
      border-radius: 50px;
      font-weight: 600;
      color: white;
      padding: 12px 20px;
      transition: transform 0.15s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border: none;
    }

    .btn-custom:active {
      transform: translateY(2px);
    }

    .btn-start { background: linear-gradient(90deg,#2dd4bf,#60a5fa); }
    .btn-stop { background: linear-gradient(90deg,#ff6b6b,#ff8fab); }
    .btn-play { background: linear-gradient(90deg,#7c3aed,#a78bfa); }
    .btn-delete { background: linear-gradient(90deg,#f97316,#ffb86b); }
    .btn-upload { background: linear-gradient(90deg,#06b6d4,#34d399); }

    .audio-container {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    audio {
      width: 100%;
      border-radius: 10px;
    }

    #suggestionBox {
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    
   .btn-next {
    background: linear-gradient(90deg, #eaf63b, #30ee69);
    padding: 12px 30px;
    margin-bottom: 20px;
    font-size: 1.1rem;
}

    #improvedText { font-weight: 700; color: #064e3b; }
    #originalText { color: #0f172a; background: #f0f8ff; padding: 8px; border-radius: 8px; font-weight: 600; }

    @media (max-width: 768px) {
      header h1 { font-size: 2rem; }
      #taskParagraph { font-size: 1rem; padding: 18px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Practice English</h1>
    <p>Listen ‚Ä¢ Record ‚Ä¢ Improve ‚Ä¢ Repeat</p>
  </header>

  <main>
    <div class="practice-container">
      <div id="taskParagraph">Loading content...</div>

      <div class="controls">
        <button id="startBtn" class="btn-custom btn-start">üéô Start</button>
        <button id="stopBtn" class="btn-custom btn-stop" disabled>‚èπ Stop</button>
        <button id="playBtn" class="btn-custom btn-play" disabled>‚ñ∂ Play</button>
        <button id="deleteBtn" class="btn-custom btn-delete" disabled>üóë Delete</button>
        <button id="uploadBtn" class="btn-custom btn-upload" disabled>‚òÅ Upload</button>
        <button id="nextBtn" class="btn-custom btn-next" disabled>‚û° Next</button>
      </div>
      
      <div class="audio-container">
        <div id="recordingSymbol" style="display:none; font-weight:700; color:#ff1744;">üî¥ Recording...</div>
        <audio id="audioPlayback" controls style="display:none;"></audio>
      </div>

      <div id="suggestionBox">
        <h5 style="color: #059669; margin-bottom: 10px;">üí° AI Feedback</h5>
        <div><strong>What you said:</strong> <span id="originalText"></span></div>
        <div><strong>Suggestion:</strong> <span id="improvedText"></span></div>
      </div>
    </div>
  </main>

  <script>
    // Practice sentences for English learning
    const sentences = [
      "The quick brown fox jumps over the lazy dog.",
      "She sells seashells by the seashore.",
      "How much wood would a woodchuck chuck if a woodchuck could chuck wood?",
      "Peter Piper picked a peck of pickled peppers.",
      "I scream, you scream, we all scream for ice cream!",
      "The weather in winter is wonderful for walking.",
      "Technology has transformed the way we communicate today.",
      "Reading regularly helps improve vocabulary and comprehension skills.",
      "Practice makes perfect when learning a new language.",
      "Confidence comes from consistent practice and patience.",
  "The early bird catches the worm, but the second mouse gets the cheese.",
  "Actions speak louder than words in every situation.",
  "Where there's a will, there's always a way forward.",
  "Time flies when you're having fun with friends.",
  "Knowledge is power, but wisdom is knowing how to use it.",
  "The pen is mightier than the sword in modern times.",
  "Don't count your chickens before they hatch completely.",
  "Every cloud has a silver lining waiting to be discovered.",
  "Rome wasn't built in a day, and neither are dreams.",
  
  "The cat sat on the mat and watched the birds outside.",
  "My grandmother bakes the most delicious chocolate chip cookies.",
  "Students should always submit their assignments on time.",
  "The library closes at nine o'clock every evening.",
  "Fresh fruits and vegetables are essential for good health.",
  "The train arrives at platform three in five minutes.",
  "Children love playing games in the park after school.",
  "The restaurant serves authentic Italian cuisine every day.",
  "Please remember to turn off the lights before leaving.",
  "The movie theater shows the latest films every weekend.",
  
  "Communication skills are crucial for professional success in business.",
  "Environmental protection requires collective effort from everyone worldwide.",
  "Artificial intelligence is revolutionizing industries across the globe.",
  "Social media platforms connect people from different cultures seamlessly.",
  "Renewable energy sources will replace fossil fuels eventually.",
  "Online education has become increasingly popular during recent years.",
  "Global warming poses serious threats to our planet's future.",
  "Scientific research continues to unlock mysteries of the universe.",
  "Cultural diversity enriches our understanding of human experiences.",
  "Innovation drives progress in technology and scientific advancement.",
  
  "The beautiful sunset painted the sky in brilliant orange hues.",
  "Mountain climbing requires physical strength and mental determination.",
  "Ocean waves crashed against the rocky shore with tremendous force.",
  "Autumn leaves fall gently from the tall oak trees.",
  "The garden blooms with colorful flowers throughout the spring season.",
  "Desert landscapes showcase nature's ability to survive harsh conditions.",
  "Rainforests contain incredible biodiversity that scientists continue studying.",
  "Polar bears adapt to extreme cold temperatures in Arctic regions.",
  "Tropical beaches attract millions of tourists seeking relaxation annually.",
  "Wildlife conservation efforts protect endangered species from extinction.",
  
  "Cooking requires creativity, patience, and attention to detail.",
  "Music has the power to heal hearts and inspire souls.",
  "Photography captures precious moments that last forever in memory.",
  "Dancing expresses emotions that words sometimes cannot convey properly.",
  "Reading opens doors to new worlds and endless possibilities.",
  "Writing allows people to share their thoughts and experiences.",
  "Painting transforms blank canvases into masterpieces of artistic expression.",
  "Sports teach valuable lessons about teamwork and perseverance.",
  "Gardening connects people with nature and provides peaceful meditation.",
  "Traveling broadens perspectives and creates unforgettable life experiences."
    ];

    let currentSentenceIndex = 0;
    let mediaRecorder;
    let audioChunks = [];
    let recordedBlob = null;
    let recognition;
    let recognizedText = '';

    // DOM elements
    const taskParagraph = document.getElementById('taskParagraph');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const playBtn = document.getElementById('playBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const nextBtn = document.getElementById('nextBtn');
    const recordingSymbol = document.getElementById('recordingSymbol');
    const audioPlayback = document.getElementById('audioPlayback');
    const suggestionBox = document.getElementById('suggestionBox');
    const originalText = document.getElementById('originalText');
    const improvedText = document.getElementById('improvedText');

    // Speech recognition setup
    function setupSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = (event) => {
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            }
          }
          if (finalTranscript) {
            recognizedText = finalTranscript.trim();
          }
        };

        recognition.onerror = (event) => {
          console.log('Speech recognition error:', event.error);
        };
      } else {
        console.log('Speech recognition not supported');
      }
    }

    // Grammar correction using LanguageTool API
    async function analyzeAndCorrectSpeech(recognizedText, targetSentence) {
      try {
        // Use LanguageTool API for grammar checking
        const response = await fetch('https://api.languagetool.org/v2/check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            'text': recognizedText,
            'language': 'en-US',
            'enabledOnly': 'false'
          })
        });

        const data = await response.json();
        let correctedText = recognizedText;
        let corrections = [];

        // Apply corrections from API
        if (data.matches && data.matches.length > 0) {
          // Sort matches by offset in descending order to avoid position shifts
          const sortedMatches = data.matches.sort((a, b) => b.offset - a.offset);
          
          sortedMatches.forEach(match => {
            if (match.replacements && match.replacements.length > 0) {
              const replacement = match.replacements[0].value;
              const originalText = correctedText.substring(match.offset, match.offset + match.length);
              
              corrections.push({
                original: originalText,
                corrected: replacement,
                message: match.message
              });
              
              correctedText = correctedText.substring(0, match.offset) + 
                            replacement + 
                            correctedText.substring(match.offset + match.length);
            }
          });
        }

        // Calculate accuracy with target sentence
        const accuracy = calculateAccuracy(recognizedText, targetSentence);
        
        return {
          originalText: recognizedText,
          correctedText: correctedText,
          targetSentence: targetSentence,
          corrections: corrections,
          accuracy: accuracy,
          hasGrammarErrors: corrections.length > 0,
          apiResponse: data
        };

      } catch (error) {
        console.error('Grammar API error:', error);
        
        // Fallback to basic corrections if API fails
        return await fallbackGrammarCorrection(recognizedText, targetSentence);
      }
    }

    // Fallback grammar correction if API fails
    async function fallbackGrammarCorrection(recognizedText, targetSentence) {
      const basicCorrections = [
        { wrong: /\bi am going to went\b/gi, correct: "I am going to go" },
        { wrong: /\bhe don't\b/gi, correct: "he doesn't" },
        { wrong: /\bshe don't\b/gi, correct: "she doesn't" },
        { wrong: /\bit don't\b/gi, correct: "it doesn't" },
        { wrong: /\bi have went\b/gi, correct: "I have gone" },
        { wrong: /\bi seen\b/gi, correct: "I saw" },
        { wrong: /\bcould of\b/gi, correct: "could have" },
        { wrong: /\bwould of\b/gi, correct: "would have" },
        { wrong: /\bshould of\b/gi, correct: "should have" },
        { wrong: /\bwanna\b/gi, correct: "want to" },
        { wrong: /\bgonna\b/gi, correct: "going to" },
        { wrong: /\bain't\b/gi, correct: "isn't" }
      ];

      let correctedText = recognizedText;
      let corrections = [];

      basicCorrections.forEach(rule => {
        if (rule.wrong.test(correctedText)) {
          const matches = correctedText.match(rule.wrong);
          if (matches) {
            corrections.push({
              original: matches[0],
              corrected: rule.correct,
              message: "Basic grammar correction"
            });
            correctedText = correctedText.replace(rule.wrong, rule.correct);
          }
        }
      });

      // Fix capitalization
      correctedText = correctedText.charAt(0).toUpperCase() + correctedText.slice(1);
      
      // Add period if missing
      if (!/[.!?]$/.test(correctedText.trim())) {
        correctedText += '.';
      }

      const accuracy = calculateAccuracy(recognizedText, targetSentence);
      
      return {
        originalText: recognizedText,
        correctedText: correctedText,
        targetSentence: targetSentence,
        corrections: corrections,
        accuracy: accuracy,
        hasGrammarErrors: corrections.length > 0
      };
    }

    // Calculate accuracy between spoken text and target
    function calculateAccuracy(spokenText, targetText) {
      const spokenWords = spokenText.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
      const targetWords = targetText.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
      
      let matches = 0;
      const maxLength = Math.max(spokenWords.length, targetWords.length);
      
      for (let i = 0; i < Math.min(spokenWords.length, targetWords.length); i++) {
        if (spokenWords[i] === targetWords[i]) {
          matches++;
        }
      }
      
      return Math.round((matches / maxLength) * 100);
    }

    // Generate improvement suggestions
    function generateImprovementSuggestion(analysisResult) {
      const { correctedText, targetSentence, accuracy, hasGrammarErrors, corrections } = analysisResult;
      
      let suggestion = "";
      
      if (hasGrammarErrors) {
        suggestion = `Your sentence can be improved like this: "${correctedText}"`;
        if (corrections.length > 0) {
          const correctionDetails = corrections.map(c => `"${c.original}" ‚Üí "${c.corrected}"`).join(', ');
          suggestion += ` (Grammar corrections: ${correctionDetails})`;
        }
      } else if (accuracy < 90) {
        suggestion = `Your sentence can be improved like this: "${targetSentence}" (Try to match the target sentence more closely)`;
      } else if (accuracy < 100) {
        suggestion = `Good job! Your sentence can be improved like this: "${targetSentence}" (Minor pronunciation adjustments needed)`;
      } else {
        suggestion = "Perfect! Your pronunciation and grammar are excellent.";
      }
      
      return suggestion;
    }

    // Initialize the app
    function init() {
      loadSentence();
      setupEventListeners();
      setupSpeechRecognition();
    }

    // Load current sentence
    function loadSentence() {
      taskParagraph.textContent = sentences[currentSentenceIndex];
      resetRecording();
    }

    // Setup event listeners
    function setupEventListeners() {
      startBtn.addEventListener('click', startRecording);
      stopBtn.addEventListener('click', stopRecording);
      playBtn.addEventListener('click', playRecording);
      deleteBtn.addEventListener('click', deleteRecording);
      
      // Upload button functionality with real API
      uploadBtn.addEventListener('click', async function() {
        if (!recordedBlob || !recognizedText) {
          alert('Please record your voice first before uploading.');
          return;
        }

        // Show uploading state
        this.textContent = '‚è≥ Analyzing...';
        this.disabled = true;

        try {
          // Get current target sentence (from your database)
          const currentTargetSentence = taskParagraph.textContent;
          
          // Analyze the speech using real API
          const analysisResult = await analyzeAndCorrectSpeech(recognizedText, currentTargetSentence);
          
          // Generate improvement suggestion
          const improvementSuggestion = generateImprovementSuggestion(analysisResult);
          
          // Display results
          originalText.textContent = `"${analysisResult.originalText}"`;
          improvedText.textContent = improvementSuggestion;
          suggestionBox.style.display = 'flex';
          
          // Update button state
          this.textContent = '‚úÖ Analyzed!';
          
          // Reset button after delay and enable next
          setTimeout(() => {
            this.textContent = '‚òÅ Upload';
            this.disabled = false;
            nextBtn.disabled = false;
          }, 2000);
          
        } catch (error) {
          console.error('Analysis failed:', error);
          this.textContent = '‚ùå Error';
          
          // Show error message
          originalText.textContent = 'Analysis failed. Please try again.';
          improvedText.textContent = 'There was an error processing your speech. Check your internet connection.';
          suggestionBox.style.display = 'flex';
          
          // Reset button
          setTimeout(() => {
            this.textContent = '‚òÅ Upload';
            this.disabled = false;
          }, 3000);
        }
      });

      // Next button functionality for database content
      nextBtn.addEventListener('click', function() {
        // Hide current feedback
        suggestionBox.style.display = 'none';
        
        // Reset recording state
        recordedBlob = null;
        recognizedText = '';
        audioPlayback.style.display = 'none';
        audioPlayback.src = '';
        
        // Reset button states
        startBtn.disabled = false;
        stopBtn.disabled = true;
        playBtn.disabled = true;
        deleteBtn.disabled = true;
        uploadBtn.disabled = true;
        uploadBtn.textContent = '‚òÅ Upload';
        this.disabled = true;
        
        // Here you would typically fetch the next content from your database
        // Example AJAX call (replace with your actual database call):
        /*
        fetch('/api/next-sentence', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ currentId: currentSentenceId })
        })
        .then(response => response.json())
        .then(data => {
          taskParagraph.textContent = data.sentence;
          currentSentenceId = data.id;
        })
        .catch(error => {
          console.error('Error fetching next sentence:', error);
        });
        */
        
        // For now, just increment to next sentence in your existing array
        currentSentenceIndex = (currentSentenceIndex + 1) % sentences.length;
        taskParagraph.textContent = sentences[currentSentenceIndex];
      });
    }

    // Start recording
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        recognizedText = '';

        // Start speech recognition
        if (recognition) {
          recognition.start();
        }

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const audioUrl = URL.createObjectURL(recordedBlob);
          audioPlayback.src = audioUrl;
          audioPlayback.style.display = 'block';
          
          // Stop speech recognition
          if (recognition) {
            recognition.stop();
          }
          
          // Enable buttons
          playBtn.disabled = false;
          deleteBtn.disabled = false;
          uploadBtn.disabled = false;
        };

        mediaRecorder.start();
        
        // Update UI
        startBtn.disabled = true;
        stopBtn.disabled = false;
        recordingSymbol.style.display = 'block';
        
      } catch (error) {
        alert('Microphone access denied. Please allow microphone access to record.');
      }
    }

    // Stop recording
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
      
      // Update UI
      startBtn.disabled = false;
      stopBtn.disabled = true;
      recordingSymbol.style.display = 'none';
    }

    // Play recording
    function playRecording() {
      if (audioPlayback.src) {
        audioPlayback.play();
      }
    }

    // Delete recording
    function deleteRecording() {
      resetRecording();
    }

    // Reset recording state
    function resetRecording() {
      recordedBlob = null;
      recognizedText = '';
      audioPlayback.style.display = 'none';
      audioPlayback.src = '';
      
      // Reset buttons
      startBtn.disabled = false;
      stopBtn.disabled = true;
      playBtn.disabled = true;
      deleteBtn.disabled = true;
      uploadBtn.disabled = true;
      uploadBtn.textContent = '‚òÅ Upload';
      
      recordingSymbol.style.display = 'none';
      suggestionBox.style.display = 'none';
    }

    // Start the app when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98cb972c8549178a',t:'MTc2MDE1NjY5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
